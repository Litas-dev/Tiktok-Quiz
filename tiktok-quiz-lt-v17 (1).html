<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TikTok Viktorina — v17 (atsakymai sumaišyti)</title>
  <style>
    :root{
      --bg:#0b0b0f;--card:#14141c;--muted:#8b8ca7;--text:#f2f3f8;--accent:#7c5cff;
      --ok:#10b981;--bad:#ef4444;--radius:18px;--pad:14px;--gap:12px;--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:clamp(14px,2vw,16px);
      background:radial-gradient(1200px 800px at 70% -10%,#131327 0%,#0b0b0f 60%),var(--bg);
      color:var(--text)
    }
    .wrap{max-width:980px;margin:0 auto;padding:env(safe-area-inset-top) 14px env(safe-area-inset-bottom)}
    header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;padding:10px 0}
    .logo{width:38px;height:38px;border-radius:12px;background:conic-gradient(from 210deg,var(--accent),#ff2d55,#ff8a00,var(--accent));box-shadow:0 6px 20px rgba(124,92,255,.35)}
    h1{font-size:clamp(16px,2.4vw,20px);margin:0}.muted{color:var(--muted)}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 14px;font-weight:700;font-size:16px;background:var(--accent);color:#fff;box-shadow:var(--shadow);cursor:pointer}
    .btn.small{padding:8px 10px;font-size:14px;border-radius:12px}.btn.secondary{background:#1f1f2a;color:#f2f3f8}
    .btn.ghost{background:transparent;border:1px solid #2b2b3d;box-shadow:none}
    .icon-btn{appearance:none;border:0;background:transparent;cursor:pointer;padding:8px;border-radius:10px}
    .icon-btn:focus{outline:2px solid #3b3b55}
    .hamburger{width:28px;height:20px;position:relative}
    .hamburger span{position:absolute;left:0;right:0;height:3px;background:#e7e8f8;border-radius:4px;transition:.2s}
    .hamburger span:nth-child(1){top:0}
    .hamburger span:nth-child(2){top:8.5px}
    .hamburger span:nth-child(3){bottom:0}
    .hamburger.active span:nth-child(1){transform:translateY(8.5px) rotate(45deg)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:translateY(-8.5px) rotate(-45deg)}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:var(--gap)}
    .card{background:rgba(20,20,28,.9);backdrop-filter:blur(6px);border:1px solid #1d1d2b;border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
    .pill{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #2a2a3a;color:#cfd0e6;display:inline-flex;gap:6px;align-items:center}
    .note{display:none;font-size:13px;margin-top:8px;padding:8px;border:1px dashed #2b2b3d;border-radius:10px;color:#cfd0e6}
    .winners{display:grid;gap:8px;margin-top:8px}
    .winner{display:flex;justify-content:space-between;align-items:center;background:#0f0f18;border:1px solid #1b1b29;border-radius:12px;padding:8px 10px}

    /* Timer */
    .timer{height:10px;background:#1a1a26;border-radius:999px;overflow:hidden;border:1px solid #2a2a3a;min-width:180px}
    .timer>div{height:100%;width:100%;background:linear-gradient(90deg,var(--accent),#ff2d55);transform-origin:left center;transform:scaleX(1)}

    /* Answers block: bigger, clearer */
    #answers{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    #answers .choice{
      display:flex;align-items:center;justify-content:center;
      padding:clamp(12px,2.6vw,18px) clamp(12px,3vw,20px);
      border-radius:16px;border:1px solid #2b2b3d;background:#121225;
      color:#eef; font-weight:800; letter-spacing:.2px;
      font-size:clamp(18px,2.8vw,24px);
      min-height:56px; text-align:center
    }
    @media (min-width:980px){ #answers{grid-template-columns:repeat(4,minmax(0,1fr))} }
    @media (max-width:520px){ #answers{grid-template-columns:1fr} }

    table{width:100%;border-collapse:separate;border-spacing:0 8px}th,td{font-size:13px;padding:8px 10px;text-align:left}tr{background:#0f0f18;border:1px solid #1b1b29}
    tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .ansbtn{min-width:44px;padding:10px 0;text-align:center;border-radius:10px;border:1px solid #2b2b3d;background:#141428;color:#cfd0e6;font-weight:800;cursor:pointer}
    .ansbtn.lock{opacity:.5;pointer-events:none}.ansbtn.pick{background:#1d233f;color:#fff;border-color:#37407a}
    .ansbtn.correct{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.5);color:#c9f0e3}.ansbtn.wrong{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.5);color:#f6c8c8}

    /* Score controls */
    .scorecell{display:inline-flex;align-items:center;gap:6px}
    .scorebtn{width:26px;height:26px;border-radius:8px;border:1px solid #2b2b3d;background:#0f0f18;color:#e6e8ff;font-weight:800;line-height:1;cursor:pointer}
    .scoreval{min-width:38px;text-align:center;font-weight:800}

    /* Desktop header nav vs mobile hamburger */
    .desktop-nav{display:flex;gap:8px}
    .mobile-nav{display:none}
    @media (max-width:720px){
      .desktop-nav{display:none}
      .mobile-nav{display:block}
    }

    /* Drawer */
    #drawerMask{position:fixed;inset:0;background:rgba(0,0,20,.4);backdrop-filter:blur(2px);display:none;z-index:70}
    #drawer{position:fixed;top:0;bottom:0;left:0;width:min(80vw,280px);background:#0e0e18;border-right:1px solid #1b1b29;transform:translateX(-100%);transition:transform .18s ease;z-index:80;padding:16px;display:flex;flex-direction:column;gap:10px}
    #drawer.open{transform:translateX(0)}
    #drawer h3{margin:0 0 8px 0;font-size:16px}
    #drawer .navbtn{width:100%;text-align:left}

    /* Special overlay */
    #specialOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,20,.6);backdrop-filter:blur(6px);z-index:60}
    #specialBox{max-width:720px;width:min(92vw,700px)}
    .optgrid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr));margin-top:10px}
    @media(max-width:520px){ .optgrid{grid-template-columns:1fr} }
    .optbtn{padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#121225;color:#e9eaf8;font-weight:800;cursor:pointer;text-align:center}
    .optbtn.correct{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.5)}
    .optbtn.wrong{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.5)}

    /* Status bar */
    #statusBar{position:fixed;right:10px;bottom:10px;display:flex;gap:8px;z-index:90}
    .status{padding:6px 8px;border-radius:999px;border:1px solid #2a2a3a;background:#0e0e18;color:#cfd0e6;font-size:12px}

    /* Hide KPI container visually */
    .kpi-wrap{display:none !important}
    .visually-hidden{position:absolute !important;left:-9999px;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="row">
      <div class="logo"></div>
      <div>
        <h1>TikTok Viktorina v17</h1>
        <div class="muted">Atsakymų tvarka maišoma. Teisingas ≠ visada A.</div>
      </div>
    </div>
    <div class="desktop-nav">
      <button id="tabPlayBtn" class="btn small secondary">Žaisti</button>
      <button id="tabPlayersBtn" class="btn small">Dalyviai</button>
      <button id="tabBankBtn" class="btn small secondary">Klausimai</button>
      <button id="tabSettingsBtn" class="btn small secondary">Nustatymai</button>
    </div>
    <div class="mobile-nav">
      <button id="hamburgerBtn" class="icon-btn" aria-label="Atverti meniu" aria-expanded="false" aria-controls="drawer">
        <div id="hamb" class="hamburger"><span></span><span></span><span></span></div>
      </button>
    </div>
  </header>

  <!-- PLAY -->
  <section id="play" class="grid">
    <div class="card grid">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="timer" style="flex:1"><div id="timerBar"></div></div>
        <div class="pill" id="timeText">20 s</div>
        <div class="pill" id="statusPill">🔓 Atidaryta</div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <div class="pill" id="meta">Kategorija • Sunkumas</div>
        <div class="pill" id="qIndex">0/0</div>
      </div>
      <div class="card" style="background:#111121;border:1px solid #24243a">
        <div id="questionText" style="font-size:clamp(18px,2.6vw,22px);font-weight:700">Spausk „Pradėti“.</div>
        <div id="answers" style="margin-top:10px"></div>
        <div id="noteInline" class="note"></div>
      </div>
      <div class="row" style="gap:8px">
        <button id="startBtn" class="btn full" data-mode="start">Pradėti</button>
        <button id="lockBtn" class="btn secondary" style="display:none">Užrakinti</button>
        <button id="revealBtn" class="btn secondary" style="display:none">Parodyti</button>
      </div>

      <div class="kpi-wrap">
        <div class="kpi"><div class="big visually-hidden" id="pCount">0</div><div class="lbl visually-hidden">Dalyvių</div></div>
        <div class="kpi"><div class="big visually-hidden" id="aCount">0</div><div class="lbl visually-hidden">Atsakymų</div></div>
        <div class="kpi"><div class="big visually-hidden" id="acc">0%</div><div class="lbl visually-hidden">Tikslumas</div></div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Dalyvių atsakymai</strong>
        <div class="pill" id="countsPill">A:0 • B:0 • C:0 • D:0</div>
      </div>
      <div class="table-wrap">
        <table id="answersTable">
          <thead><tr><th>#</th><th>Vardas</th><th>Taškai</th><th colspan="4">Pasirinkimas</th><th>Būsena</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="leaderboard" class="card">
      <strong>Lyderių lenta</strong>
      <div id="lbList" class="grid" style="margin-top:8px;gap:6px"></div>
    </div>
  </section>

  <!-- PLAYERS -->
  <section id="players" class="card grid" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Dalyviai</strong>
      <div class="row">
        <button id="exportPlayers" class="btn small secondary">Eksportuoti</button>
        <label class="btn small ghost" for="importPlayers">Importuoti</label>
        <input id="importPlayers" type="file" accept="application/json" style="display:none">
      </div>
    </div>
    <div class="row">
      <input id="nameInput" placeholder="Vardas" style="flex:1;padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#0f0f18;color:#f2f3f8">
      <button id="addPlayer" class="btn">Pridėti</button>
    </div>
    <div class="table-wrap">
      <table id="playersTable">
        <thead><tr><th>#</th><th>Vardas</th><th>Taškai</th><th>Veiksmai</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- BANK -->
  <section id="bank" class="card grid" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Klausimų bankas</strong>
      <div class="row">
        <button id="exportBank" class="btn small secondary">Eksportuoti JSON</button>
        <label class="btn small ghost" for="importBank">Importuoti JSON</label>
        <input id="importBank" type="file" accept="application/json" style="display:none">
      </div>
    </div>
    <div class="grid">
      <div class="row" style="grid-template-columns:1fr 1fr;gap:10px">
        <input id="cat" placeholder="Kategorija" style="flex:1;padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#0f0f18;color:#f2f3f8">
        <select id="diff" style="padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#0f0f18;color:#f2f3f8"><option>easy</option><option>medium</option><option selected>hard</option></select>
      </div>
      <textarea id="q" placeholder="Klausimas" style="padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#0f0f18;color:#f2f3f8"></textarea>
      <div class="row">
        <input id="a0" placeholder="Teisingas" style="flex:1;padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#0f0f18;color:#f2f3f8">
        <input id="aRest" placeholder="Blogi: A, B, C" style="flex:1;padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#0f0f18;color:#f2f3f8">
      </div>
      <input id="note" placeholder="Paaiškinimas (rodoma po atskleidimo)" style="padding:12px;border-radius:12px;border:1px solid #2b2b3d;background:#0f0f18;color:#f2f3f8">
      <div class="row"><button id="addQ" class="btn">Pridėti</button></div>
    </div>
    <div class="table-wrap">
      <table id="bankTable">
        <thead><tr><th>#</th><th>Klausimas</th><th>Kategorija</th><th>Sunk.</th><th>Atsakymai</th><th>Paaiškinimas</th><th>Šalinti</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<!-- Drawer -->
<div id="drawerMask" role="button" aria-label="Uždaryti meniu"></div>
<nav id="drawer" aria-label="Meniu">
  <h3>Meniu</h3>
  <button id="navPlay" class="btn small secondary navbtn">Žaisti</button>
  <button id="navPlayers" class="btn small navbtn">Dalyviai</button>
  <button id="navBank" class="btn small secondary navbtn">Klausimai</button>
  <button id="navSettings" class="btn small secondary navbtn">Nustatymai</button>
</nav>

<!-- Reveal Overlay -->
<div id="overlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,20,.55);backdrop-filter:blur(6px);z-index:50">
  <div class="card" style="max-width:720px;width:min(92vw,700px)">
    <div class="muted" style="margin-bottom:8px;text-align:center">Teisingas atsakymas</div>
    <div id="overlayAnswer" style="font-size:22px;font-weight:800;margin:6px 0 6px;text-align:center"></div>
    <div id="overlayNote" class="muted" style="font-size:14px;margin:6px 0 12px;text-align:center"></div>
    <div id="overlayWinnersWrap" style="margin-top:6px">
      <strong>Teisingai atsakė</strong>
      <div id="overlayWinners" class="winners"></div>
    </div>
    <div class="row" style="justify-content:center;margin-top:10px"><button id="nextBtn" class="btn">Tęsti</button></div>
  </div>
</div>

<!-- Special Challenge Overlay -->
<div id="specialOverlay" style="display:none">
  <div id="specialBox" class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong id="specialTitle">Iššūkio klausimas</strong>
      <div class="row">
        <div class="timer" style="flex:1;min-width:140px"><div id="specialTimerBar"></div></div>
        <div class="pill" id="specialTimeText">20 s</div>
      </div>
    </div>
    <div id="specialQuestion" style="font-size:clamp(18px,2.4vw,22px);font-weight:700;margin-top:8px"></div>
    <div id="specialOpts" class="optgrid"></div>
    <div id="specialNote" class="note"></div>
    <div id="specialResult" class="muted" style="margin-top:8px"></div>
    <div class="row" style="justify-content:center;margin-top:10px;display:none" id="specialNextWrap">
      <button id="specialNextBtn" class="btn">Tęsti</button>
    </div>
  </div>
</div>

<!-- Audio assets -->
<audio id="tickAudio" src="clock-67787.mp3" preload="auto" loop></audio>
<audio id="failAudio" src="no-luck-too-bad-disappointing-sound-effect-112943.mp3" preload="auto"></audio>

<!-- Status bar -->
<div id="statusBar">
  <span id="audioStat" class="status">Audio: užrakinta</span>
  <span id="fileStat" class="status">Failai: tikrinama</span>
</div>

<script>
// utilities
function uuidv4(){ if (crypto && crypto.randomUUID) return crypto.randomUUID(); return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{ const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16); }); }
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

// state
const LS='tiktokQuiz.v17';
const DEFAULTS={
  players:[],
  bank:[
    {q:'Kur yra Machu Picchu?',correct:'Peru',wrong:['Čilė','Bolivija','Ekvadoras'],cat:'Kultūra',diff:'hard',note:'Inkų citadelė Anduose, apie 2 430 m aukštyje.'},
    {q:'Kokia yra Lietuvos sostinė?',correct:'Vilnius',wrong:['Kaunas','Klaipėda','Šiauliai'],cat:'Geografija',diff:'easy',note:'Pirmąkart paminėtas 1323 m. Gedimino laiškuose.'}
  ],
  settings:{timePerQ:20,shuffleQs:true,overlay:true,autoLb:true,lockFirst:true,tickOn:true,tickVol:0.5}
};
function load(){try{return JSON.parse(localStorage.getItem(LS))||DEFAULTS}catch(e){return DEFAULTS}}
function save(){try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}}

let state=load();
state.players.forEach(p=>{ if(typeof p.nextMilestone!=='number') p.nextMilestone=100; });

let play={order:[],i:0,open:false,timer:null,counts:{A:0,B:0,C:0,D:0},answers:{},correctKey:'A',totalRight:0,total:0};
let special={queue:[],active:null,timer:null,correctKey:'A',q:null,opts:[],pid:null};

// audio
const tickEl = $('#tickAudio'); const failEl = $('#failAudio'); const audioStat = $('#audioStat');
let audioUnlocked=false;
function unlockAudio(){ if(audioUnlocked) return; const vol=(state.settings?.tickVol ?? 0.5); [tickEl,failEl].forEach(a=>{ if(a){ a.volume=vol; a.muted=false; }}); const tryPlay=el=>el&&el.play?el.play().then(()=>{el.pause(); audioUnlocked=true; audioStat.textContent='Audio: įjungta';}).catch(()=>{audioStat.textContent='Audio: reikia paspaudimo';}):null; Promise.resolve().then(()=>tryPlay(tickEl)).then(()=>tryPlay(failEl)).finally(()=>{ audioUnlocked=true; audioStat.textContent='Audio: įjungta'; }); document.removeEventListener('click', unlockAudio); }
document.addEventListener('click', unlockAudio, {once:true});
function tickPlay(){ if(!tickEl || !state.settings.tickOn) return; if(!audioUnlocked) return; try{ tickEl.currentTime=0; const p=tickEl.play(); if(p&&p.catch) p.catch(()=>{});}catch(e){} }
function tickStop(){ if(!tickEl) return; try{ tickEl.pause(); tickEl.currentTime=0; }catch(e){} }
function failPlay(){ if(!failEl) return; if(!audioUnlocked) return; try{ failEl.currentTime=0; const p=failEl.play(); if(p&&p.catch) p.catch(()=>{});}catch(e){} }
function bindAudioErrors(){ [tickEl,failEl].forEach(a=>{ if(!a) return; a.addEventListener('error', ()=>{ $('#fileStat').textContent='Failai: nerasta'; }); a.addEventListener('canplaythrough', ()=>{ $('#fileStat').textContent='Failai: OK'; }); }); }
bindAudioErrors();

// nav + drawer
function show(id){ ['play','players','bank','settings'].forEach(x=>{ const el=$('#'+x); if(el) el.style.display = x===id?'grid':'none'; }); }
const drawer=$('#drawer'), mask=$('#drawerMask'), hamb=$('#hamb'), hbBtn=$('#hamburgerBtn');
function openDrawer(){ if(!drawer) return; drawer.classList.add('open'); if(mask) mask.style.display='block'; if(hbBtn) hbBtn.setAttribute('aria-expanded','true'); if(hamb) hamb.classList.add('active'); }
function closeDrawer(){ if(!drawer) return; drawer.classList.remove('open'); if(mask) mask.style.display='none'; if(hbBtn) hbBtn.setAttribute('aria-expanded','false'); if(hamb) hamb.classList.remove('active'); }
if(hbBtn) hbBtn.onclick=()=>{ if(drawer.classList.contains('open')) closeDrawer(); else openDrawer(); };
if(mask) mask.onclick=closeDrawer;
window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeDrawer(); if($('#specialOverlay').style.display==='flex') endSpecial(false); } });
['navPlay','navPlayers','navBank','navSettings'].forEach(id=>{ const b=$('#'+id); if(b) b.onclick=()=>{ closeDrawer(); if(id==='navPlay') show('play'); if(id==='navPlayers') show('players'); if(id==='navBank') show('bank'); if(id==='navSettings') show('settings'); }; });
const hPlay=$('#tabPlayBtn'), hPl=$('#tabPlayersBtn'), hB=$('#tabBankBtn'), hS=$('#tabSettingsBtn');
if(hPlay) hPlay.onclick=()=>show('play'); if(hPl) hPl.onclick=()=>show('players'); if(hB) hB.onclick=()=>show('bank'); if(hS) hS.onclick=()=>show('settings');

// helpers
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
function el(t,a={},...k){const n=document.createElement(t); for(const [x,v] of Object.entries(a)){ if(x.startsWith('on')) n.addEventListener(x.slice(2),v); else if(x==='class') n.className=v; else n.setAttribute(x,v);} k.flat().forEach(c=>n.append(c?.nodeType?c:document.createTextNode(c))); return n;}

// score adjust
function adjustScore(pid, delta){
  const p = state.players.find(x=>x.id===pid);
  if(!p) return;
  p.score = Math.max(0, (p.score||0) + delta);
  save();
  renderPlayers();
  renderAnswersTable();
  updateLeaderboard();
  if(delta>0) enqueueMilestones();
}

// players
function renderPlayers(){
  const tb=$('#playersTable tbody');
  if(tb){
    tb.innerHTML='';
    state.players.forEach((p,i)=>{
      tb.appendChild(el('tr',{},
        el('td',{}, String(i+1)),
        el('td',{}, p.name),
        el('td',{}, el('div',{class:'scorecell'},
          el('button',{class:'scorebtn', title:'−10', onclick:()=>adjustScore(p.id,-10)}, '−'),
          el('span',{id:'score_'+p.id, class:'scoreval'}, String(p.score||0)),
          el('button',{class:'scorebtn', title:'+10', onclick:()=>adjustScore(p.id,10)}, '+')
        )),
        el('td',{}, el('button',{class:'btn small secondary', onclick:()=>delPlayer(i)},'Šalinti'))
      ));
    });
  }
  const c=$('#pCount'); if(c) c.textContent=state.players.length;
  updateLeaderboard();
}
function addPlayer(){ const nameEl=$('#nameInput'); if(!nameEl) return; const name=nameEl.value.trim(); if(!name) return; if(state.players.some(p=>p.name.toLowerCase()===name.toLowerCase())) return alert('Vardas jau yra'); state.players.push({name,score:0,id:uuidv4(),nextMilestone:100}); nameEl.value=''; save(); renderPlayers(); renderAnswersTable(); }
function delPlayer(i){ if(confirm('Pašalinti dalyvį?')){ state.players.splice(i,1); save(); renderPlayers(); renderAnswersTable(); } }
const addBtn=$('#addPlayer'); if(addBtn) addBtn.onclick=addPlayer;
const exP=$('#exportPlayers'); if(exP) exP.onclick=()=>{const blob=new Blob([JSON.stringify(state.players,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='players.json'; a.click(); URL.revokeObjectURL(a.href);};
const imP=$('#importPlayers'); if(imP) imP.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; const t=await f.text(); try{ const arr=JSON.parse(t); if(!Array.isArray(arr)) throw 0; state.players=arr.map(x=>({name:String(x.name),score:+(x.score||0),id:x.id||uuidv4(),nextMilestone: typeof x.nextMilestone==='number'? x.nextMilestone : 100})); save(); renderPlayers(); renderAnswersTable(); }catch{ alert('Blogas failas'); } e.target.value=''; });

// bank
function renderBank(){ const tb=$('#bankTable tbody'); if(!tb) return; tb.innerHTML=''; state.bank.forEach((r,i)=>{ const row=el('tr',{}, el('td',{}, String(i+1)), el('td',{}, r.q), el('td',{}, r.cat||'—'), el('td',{}, r.diff||'—'), el('td',{}, [el('span',{class:'pill'}, '✓ '+r.correct),' ', ...(r.wrong||[]).map(w=>el('span',{class:'pill'}, w))]), el('td',{}, r.note? r.note.slice(0,80):'—'), el('td',{}, el('button',{class:'btn small secondary', onclick:()=>{ state.bank.splice(i,1); save(); renderBank(); }}, 'Šalinti')) ); tb.appendChild(row); }); }
const addQ=$('#addQ'); if(addQ) addQ.onclick=()=>{ const q=$('#q').value.trim(), c=$('#a0').value.trim(), rest=$('#aRest').value.split(',').map(s=>s.trim()).filter(Boolean), cat=$('#cat').value.trim(), diff=$('#diff').value, note=$('#note').value.trim(); if(!q||!c||rest.length<3) return alert('Reikia klausimo, teisingo ir 3 neteisingų'); state.bank.push({q,correct:c,wrong:rest.slice(0,3),cat,diff,note}); save(); renderBank(); $('#q').value=''; $('#a0').value=''; $('#aRest').value=''; $('#cat').value=''; $('#diff').value='hard'; $('#note').value=''; };
const exB=$('#exportBank'); if(exB) exB.onclick=()=>{const blob=new Blob([JSON.stringify(state.bank,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz-bank.json'; a.click(); URL.revokeObjectURL(a.href);};
const imB=$('#importBank'); if(imB) imB.addEventListener('change', async e=>{const f=e.target.files[0]; if(!f) return; const t=await f.text(); try{ const arr=JSON.parse(t); if(!Array.isArray(arr)) throw 0; state.bank=arr; save(); renderBank(); alert('Importuota'); }catch{ alert('Neteisingas JSON'); } e.target.value=''; });

// settings
function loadSettings(){ const t=$('#timePerQ'), s=$('#shuffleQs'), on=$('#tickOn'), vol=$('#tickVol'); if(t) t.value = state.settings.timePerQ||20; if(s) s.value = state.settings.shuffleQs? '1':'0'; if(on) on.value = state.settings.tickOn? '1':'0'; if(vol){ vol.value=(state.settings.tickVol ?? 0.5); if(tickEl) tickEl.volume = (state.settings.tickVol ?? 0.5); } }
const saveBtn=$('#saveSettings'); if(saveBtn) saveBtn.onclick=()=>{ state.settings.timePerQ = Math.max(0, parseInt($('#timePerQ').value||'20',10)); state.settings.shuffleQs = $('#shuffleQs').value==='1'; state.settings.tickOn = $('#tickOn').value==='1'; state.settings.tickVol = parseFloat($('#tickVol').value||'0.5'); if(tickEl) tickEl.volume = state.settings.tickVol; save(); alert('Išsaugota'); };

// play flow
function startGame(){ if(!state.players.length) return alert('Pirmiausia pridėk dalyvius'); if(!state.bank.length) return alert('Klausimų bankas tuščias'); play.order=[...Array(state.bank.length).keys()]; if(state.settings.shuffleQs) shuffle(play.order); play.i=0; const sb=$('#startBtn'); if(sb){ sb.textContent='Kitas'; sb.dataset.mode='next'; } const lb=$('#lockBtn'), rb=$('#revealBtn'); if(lb) lb.style.display='inline-flex'; if(rb) rb.style.display='inline-flex'; nextQ(); }
function nextQ(){ clearTimer(); tickStop(); play.open=true; play.counts={A:0,B:0,C:0,D:0}; play.answers={}; updateCountsPill(); setStatus(true); if(play.i>=play.order.length){ finish(); return; } const q=state.bank[play.order[play.i]]; const qt=$('#questionText'); if(qt) qt.textContent=q.q; const meta=$('#meta'); if(meta) meta.textContent=`${q.cat||'—'} • ${q.diff||'—'}`; const qi=$('#qIndex'); if(qi) qi.textContent=`${play.i+1}/${play.order.length}`; const opts=[q.correct, ...(q.wrong||[])].slice(0,4); while(opts.length<4) opts.push(''); const order=[0,1,2,3]; shuffle(order); const keys=['A','B','C','D']; const ans=$('#answers'); if(ans){ ans.innerHTML=''; order.forEach((oi,i)=>{ const t=opts[oi]; ans.appendChild(el('div',{class:'choice'}, `${keys[i]}: ${t}`)); }); } const ni=$('#noteInline'); if(ni){ ni.style.display='none'; ni.textContent=''; } play.correctKey = keys[order.indexOf(0)] || 'A'; renderAnswersTable(); bootTimer(); }
function renderAnswersTable(){ const tb=$('#answersTable tbody'); if(!tb) return; tb.innerHTML=''; state.players.forEach((p,idx)=>{ const tr=el('tr',{}, el('td',{}, String(idx+1)), el('td',{}, p.name), el('td',{}, el('div',{class:'scorecell'}, el('button',{class:'scorebtn', title:'−10', onclick:()=>adjustScore(p.id,-10)}, '−'), el('span',{id:'score_'+p.id, class:'scoreval'}, String(p.score||0)), el('button',{class:'scorebtn', title:'+10', onclick:()=>adjustScore(p.id,10)}, '+') )), ...['A','B','C','D'].map(k=> el('td',{}, el('div',{class:'ansbtn','data-k':k, onclick:()=>pick(p.id,k)}, k))), el('td',{}, el('span',{id:'st_'+p.id, class:'pill'}, '—')) ); tb.appendChild(tr); }); const ac=$('#aCount'); if(ac) ac.textContent = Object.keys(play.answers).length; const acc=$('#acc'); if(acc) acc.textContent = play.total? Math.round(100*play.totalRight/play.total)+'%':'0%'; }
function pick(pid,key){ if(!play.open) return; if(state.settings.lockFirst && play.answers[pid]) return; play.answers[pid]=key; const rIndex = state.players.findIndex(p=>p.id===pid); const row = $$('#answersTable tbody tr')[rIndex]; if(row) row.querySelectorAll('.ansbtn').forEach(b=> b.classList.toggle('pick', b.getAttribute('data-k')===key)); play.counts={A:0,B:0,C:0,D:0}; Object.values(play.answers).forEach(k=> play.counts[k]=(play.counts[k]||0)+1); updateCountsPill(); const ac=$('#aCount'); if(ac) ac.textContent = Object.keys(play.answers).length; const st=$('#st_'+pid); if(st) st.textContent='užfiksuota'; }
function updateCountsPill(){ const cp=$('#countsPill'); if(cp) cp.textContent = `A:${play.counts.A||0} • B:${play.counts.B||0} • C:${play.counts.C||0} • D:${play.counts.D||0}`; }
function lockNow(){ play.open=false; setStatus(false); clearTimer(); tickStop(); }
function reveal(){ const q=state.bank[play.order[play.i]]; let correctCount = 0; const winners=[]; const rows = $$('#answersTable tbody tr'); rows.forEach((tr,i)=>{ const pid = state.players[i]?.id; if(!pid) return; const ans = play.answers[pid]; tr.querySelectorAll('.ansbtn').forEach(b=>{ const k=b.getAttribute('data-k'); if(k===play.correctKey) b.classList.add('correct'); if(ans && ans!==play.correctKey && k===ans) b.classList.add('wrong'); b.classList.add('lock'); }); if(ans===play.correctKey){ state.players[i].score=(state.players[i].score||0)+10; correctCount++; play.totalRight++; const st=$('#st_'+pid); if(st) st.textContent='✓'; winners.push({name: state.players[i].name, score: state.players[i].score}); } else { const st=$('#st_'+pid); if(st) st.textContent = ans? '×':'—'; } }); if(correctCount===0){ failPlay(); } play.total++; save(); renderPlayers(); const note = q.note||''; $('#overlayAnswer').textContent = q.correct||''; $('#overlayNote').textContent = note; const box = $('#overlayWinners'); box.innerHTML=''; if(winners.length){ winners.sort((a,b)=> b.score-a.score); winners.forEach(w=>box.appendChild(el('div',{class:'winner'}, el('div',{}, w.name), el('div',{}, String(w.score))))); } else { box.appendChild(el('div',{class:'winner'}, el('div',{}, 'Niekas neatsakė teisingai'), el('div',{}, '0'))); } $('#overlayWinnersWrap').style.display='block'; const ni=$('#noteInline'); if(ni){ ni.textContent = note; ni.style.display = note? 'block':'none'; } if(state.settings.overlay) $('#overlay').style.display='flex'; updateKPIs(); setStatus(false); clearTimer(); tickStop(); enqueueMilestones(); }
function finish(){ const qt=$('#questionText'); if(qt) qt.textContent='Baigta'; const ans=$('#answers'); if(ans) ans.innerHTML=''; setStatus(false); clearTimer(); tickStop(); }
function setStatus(open){ play.open=open; const pill=$('#statusPill'); if(pill){ pill.textContent=open?'🔓 Atidaryta':'🔒 Uždaryta'; } }
function updateKPIs(){ const acc=$('#acc'); if(acc) acc.textContent = play.total? Math.round(100*play.totalRight/play.total)+'%':'0%'; }

function updateLeaderboard(){ const top=[...state.players].sort((a,b)=>(b.score||0)-(a.score||0)).slice(0,10); const box=$('#lbList'); if(!box) return; box.innerHTML=''; if(!top.length){ box.appendChild(el('div',{}, 'Dar nėra taškų')); return; } top.forEach((u,i)=> box.appendChild(el('div',{class:'row',style:'justify-content:space-between'}, el('div',{}, `${i+1}. ${u.name}`), el('div',{}, String(u.score||0)) )) ); }

// Timer (main)
function bootTimer(){ const dur = state.settings.timePerQ; const bar = $('#timerBar'); const tLabel=$('#timeText'); if(!dur || dur<=0){ if(bar) bar.style.transform='scaleX(1)'; if(tLabel) tLabel.textContent='∞'; return; } let start=Date.now(), t=dur; if(bar) bar.style.transform='scaleX(1)'; if(tLabel) tLabel.textContent=Math.ceil(t)+' s'; tickPlay(); play.timer=setInterval(()=>{ const elapsed=(Date.now()-start)/1000; t=Math.max(0,dur-elapsed); if(bar) bar.style.transform=`scaleX(${t/dur})`; if(tLabel) tLabel.textContent=Math.ceil(t)+' s'; if(t<=0){ clearInterval(play.timer); play.timer=null; lockNow(); } },50); }
function clearTimer(){ if(play.timer){ clearInterval(play.timer); play.timer=null; } }

// Buttons
const sb=$('#startBtn'); if(sb) sb.onclick=()=>{ if(sb.dataset.mode!=='next'){ startGame(); } else { play.i++; nextQ(); } };
const lb=$('#lockBtn'); if(lb) lb.onclick=lockNow;
const rb=$('#revealBtn'); if(rb) rb.onclick=reveal;
const nb=$('#nextBtn'); if(nb) nb.onclick=()=>{ $('#overlay').style.display='none'; if(special.queue.length>0 && !special.active){ startSpecial(); } else { play.i++; nextQ(); } };

// Special challenge
function enqueueMilestones(){ state.players.forEach(p=>{ if(typeof p.nextMilestone!=='number') p.nextMilestone=100; while(p.nextMilestone<=500 && p.score>=p.nextMilestone){ special.queue.push({pid:p.id, at:p.nextMilestone}); p.nextMilestone += 100; } }); save(); }
function pickRandomQuestion(){ const idx = Math.floor(Math.random()*state.bank.length); const q = state.bank[idx]; const opts=[q.correct, ...(q.wrong||[])].slice(0,4); const keys=['A','B','C','D']; const order=[0,1,2,3]; shuffle(order); const laid=order.map((oi,i)=>({k:keys[i], text: opts[oi], isRight: oi===0})); const correctKey = laid.find(x=>x.isRight)?.k || 'A'; return {q, laid, correctKey}; }
function startSpecial(){ if(special.active || special.queue.length===0) return; special.active = special.queue.shift(); const p = state.players.find(x=>x.id===special.active.pid); if(!p){ special.active=null; if(special.queue.length) startSpecial(); else { play.i++; nextQ(); } return; } const picked = pickRandomQuestion(); special.q = picked.q; special.opts = picked.laid; special.correctKey = picked.correctKey; special.pid = p.id; $('#specialTitle').textContent = `Iššūkio klausimas • ${p.name} (${special.active.at} taškų)`; $('#specialQuestion').textContent = picked.q.q; const box = $('#specialOpts'); box.innerHTML=''; picked.laid.forEach(o=>{ const btn=el('button',{class:'optbtn','data-k':o.k, onclick:()=>specialPick(o.k)}, `${o.k}: ${o.text}`); box.appendChild(btn); }); const sn=$('#specialNote'); if(sn){ sn.style.display = picked.q.note? 'block':'none'; sn.textContent = picked.q.note||''; } $('#specialResult').textContent=''; $('#specialNextWrap').style.display='none'; $('#specialOverlay').style.display='flex'; bootSpecialTimer(); }
function specialPick(key){ clearSpecialTimer(); tickStop(); const correct = key===special.correctKey; const p = state.players.find(x=>x.id===special.pid); $$('#specialOpts .optbtn').forEach(b=>{ const k=b.getAttribute('data-k'); if(k===special.correctKey) b.classList.add('correct'); if(k===key && !correct) b.classList.add('wrong'); b.disabled=true; }); if(correct){ p.score=(p.score||0)+10; $('#specialResult').textContent = `✓ Teisingai (+10).` } else { p.score = Math.floor((p.score||0) * 0.5); failPlay(); $('#specialResult').textContent = `× Klaida. Sudeginta 50% taškų.` } save(); renderPlayers(); $('#specialNextWrap').style.display='flex'; }
function bootSpecialTimer(){ const dur = state.settings.timePerQ; const bar = $('#specialTimerBar'); const tLabel=$('#specialTimeText'); if(!dur || dur<=0){ if(bar) bar.style.transform='scaleX(1)'; if(tLabel) tLabel.textContent='∞'; return; } let start=Date.now(), t=dur; if(bar) bar.style.transform='scaleX(1)'; if(tLabel) tLabel.textContent=Math.ceil(t)+' s'; tickPlay(); special.timer=setInterval(()=>{ const elapsed=(Date.now()-start)/1000; t=Math.max(0,dur-elapsed); if(bar) bar.style.transform=`scaleX(${t/dur})`; if(tLabel) tLabel.textContent=Math.ceil(t)+' s'; if(t<=0){ clearInterval(special.timer); special.timer=null; specialPick(''); } },50); }
function clearSpecialTimer(){ if(special.timer){ clearInterval(special.timer); special.timer=null; } }
function endSpecial(goNext=true){ clearSpecialTimer(); tickStop(); special.active=null; special.q=null; special.pid=null; special.opts=[]; $('#specialOverlay').style.display='none'; if(special.queue.length>0){ startSpecial(); } else if(goNext){ play.i++; nextQ(); } }
const sNext=$('#specialNextBtn'); if(sNext) sNext.onclick=()=>endSpecial(true);

// boot
renderPlayers(); renderBank(); loadSettings(); show('play'); renderAnswersTable(); updateLeaderboard();
</script>
</body>
</html>
